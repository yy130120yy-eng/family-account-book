<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è®°è´¦åŠ©æ‰‹ - å¤šç”¨æˆ·å®‰å…¨åŠ å¼ºç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 17px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
        .header { text-align: center; color: white; margin-bottom: 32px; }
        .header h1 { font-size: 2.7rem; font-weight: bold; margin-bottom: 4px; text-shadow: 2px 2px 6px rgba(0,0,0,0.23); }
        .header p { font-size: 1.2rem; opacity: 0.93; }
        .main-app .tab-content h2 { font-size: 2rem; font-weight: bold; margin-bottom: 30px; letter-spacing:2px; color: #243d4d; }
        .main-app .tab-content { font-size: 1.1em; }
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 60vh; }
        .auth-card { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; }
        .auth-tabs { display: flex; margin-bottom: 20px; border-radius: 10px; overflow: hidden; background: #f8f9fa; }
        .auth-tab { flex: 1; padding: 12px; cursor: pointer; transition: all 0.3s ease; border: none; background: transparent; font-size: 15px; font-weight: 500; }
        .auth-tab.active { background: #4CAF50; color: white; }
        .auth-tab:hover { background: #45a049; color: white; }
        .form-group { margin-bottom: 14px; text-align: left; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4CAF50; }
        .btn { background: #4CAF50; color: white; border: none; padding: 11px 22px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease; width: 100%; margin-bottom: 12px; }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .inline { display: inline-block; margin-left: 8px; }
        .link { color: #4CAF50; cursor: pointer; text-decoration: underline; font-size: 14px; }
        .hint { color: #666; font-size: 12px; }
        .code-box { display:flex; gap:8px; }
        .code-box input { text-align:center; font-weight:700; letter-spacing:2px; }
        .user-info { background: white; border-radius: 15px; padding: 16px; margin-bottom: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .user-details { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(45deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; }
        .user-name { font-size: 16px; font-weight: 600; color: #333; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .logout-btn:hover { background: #c82333; }
        .main-app { display: none; }
        .main-app.show { display: block; }
        .nav-tabs { display: flex; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
        .nav-tab { flex: 1; padding: 12px 16px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: none; background: white; font-size: 15px; font-weight: 500; }
        .nav-tab.active { background: #4CAF50; color: white; }
        .nav-tab:hover { background: #45a049; color: white; }
        .content { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); min-height: 460px; }
        .voice-status { margin-top: 8px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 500; display: none; }
        .voice-status.listening { background: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; display: block; }
        .voice-status.processing { background: #fff3e0; color: #f57c00; border: 2px solid #ff9800; display: block; }
        .voice-status.success { background: #e8f5e8; color: #2e7d32; border: 2px solid #4caf50; display: block; }
        .voice-status.error { background: #ffebee; color: #c62828; border: 2px solid #f44336; display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 18px; }
        .stat-card { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 1.6rem; margin-bottom: 8px; }
        .transaction-list { max-height: 380px; overflow-y: auto; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; }
        .transaction-amount { font-weight: 600; }
        .transaction-amount.income { color: #4CAF50; }
        .transaction-amount.expense { color: #f44336; }
        .quick-templates { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 10px; }
        .template-btn { background: #f8f9fa; border: 2px solid #e0e0e0; padding: 12px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .template-btn:hover { background: #4CAF50; color: white; border-color: #4CAF50; }
        .search-filter { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
        .error-message { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #f44336; }
        .success-message { background: #e8f5e8; color: #2e7d32; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #4caf50; }
        .section-card { border:1px solid #e5e7eb; border-radius:10px; padding:14px; margin-bottom:12px; background:#fafafa; }
        .delete-btn { background: none; border: none; outline: none; cursor: pointer; margin-left: 12px; min-width: 36px; min-height:36px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.18s; }
        .delete-btn:hover { background: #ffeaea; box-shadow: 0 0 6px #e53935aa; }
        .delete-icon { font-size: 21px; width:21px;height:21px; color: #e53935; pointer-events: none; }
        /* ç»Ÿè®¡åˆ†æå†…å®¹åŒºå±…ä¸­ç¾åŒ– */
        #stats.tab-content { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 350px; }
        #stats > h2 { margin-bottom: 32px; margin-top: 18px; text-align: center; font-size: 2.1rem; color: #203554; }
        #expenseChart { display: block; margin: 0 auto; margin-bottom: 12px; }
        @media (max-width: 768px) { .container { padding: 10px; } .header h1 { font-size: 1.8rem; } .content { padding: 16px; } .nav-tab { padding: 10px; font-size: 14px; } .auth-card { padding: 22px 16px; } .user-info { flex-direction: column; gap: 10px; text-align: center; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  å®¶åº­è®°è´¦åŠ©æ‰‹</h1>
            <p>å¤šç”¨æˆ·å®‰å…¨åŠ å¼ºç‰ˆï¼šéªŒè¯ç ã€äºŒæ­¥éªŒè¯ã€å¤šé¢˜å®‰å…¨é—®é¢˜ã€å†·å´æœºåˆ¶</p>
        </div>

        <div id="authContainer" class="auth-container">
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="showAuthTab(event, 'login')">ç™»å½•</button>
                    <button class="auth-tab" data-tab="register" onclick="showAuthTab(event, 'register')">æ³¨å†Œ</button>
                    <button class="auth-tab" data-tab="reset" onclick="showAuthTab(event, 'reset')">æ‰¾å›å¯†ç </button>
                </div>

                <div id="loginForm" class="auth-form">
                    <h2>æ¬¢è¿å›æ¥</h2>
                    <p class="hint" style="margin-bottom: 10px;">è¿ç»­å¤±è´¥å°†è§¦å‘è´¦æˆ·å†·å´</p>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="loginUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="loginPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button type="submit" class="btn">ç™»å½•</button>
                        <div style="text-align:center; margin-top:6px;">
                            <span class="link" onclick="showAuthTabByName('reset')">å¿˜è®°å¯†ç ï¼Ÿ</span>
                        </div>
                        <div id="lockHint" class="hint" style="display:none; margin-top:8px;"></div>
                    </form>
                </div>

                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2>åˆ›å»ºè´¦æˆ·</h2>
                    <p class="hint" style="margin-bottom: 10px;">è¯·è®¾ç½®å®‰å…¨é—®é¢˜ï¼Œä¾¿äºå¿˜è®°å¯†ç æ—¶æ‰¾å›</p>
                    <form id="registerFormElement">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="registerUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¯†ç </label>
                                <input type="password" id="registerPassword" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤å¯†ç </label>
                                <input type="password" id="confirmPassword" required placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="form-group">
                                <label>å®‰å…¨é—®é¢˜ï¼ˆå¯æ·»åŠ å¤šé¢˜ï¼‰</label>
                                <div id="securityQuestionsContainer"></div>
                                <button type="button" class="btn btn-secondary" onclick="addSecurityQuestionItem()">æ·»åŠ å®‰å…¨é—®é¢˜</button>
                            </div>
                        </div>

                        <button type="submit" class="btn">æ³¨å†Œ</button>
                    </form>
                </div>

                <div id="resetForm" class="auth-form" style="display: none;">
                    <h2>æ‰¾å›å¯†ç </h2>
                    <p class="hint" style="margin-bottom: 10px;">ä»…éœ€å›ç­”å·²è®¾ç½®çš„å®‰å…¨é—®é¢˜ï¼ˆä»»æ„ä¸€é¢˜æ­£ç¡®å³å¯ï¼‰</p>
                    <form id="resetFormElement">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="resetUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>

                        <div class="section-card">
                            <div class="form-group">
                                <label>å®‰å…¨é—®é¢˜</label>
                                <div id="resetSecurityDynamicArea" class="hint">å¡«å†™ç”¨æˆ·ååå°†æ˜¾ç¤ºå¯¹åº”é—®é¢˜</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>æ–°å¯†ç </label>
                                <input type="password" id="newPassword" required placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="confirmNewPassword" required placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                            </div>
                        </div>
                        <button type="submit" class="btn">é‡ç½®å¯†ç </button>
                        <div style="text-align:center; margin-top:6px;">
                            <span class="link" onclick="showAuthTabByName('login')">è¿”å›ç™»å½•</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="mainApp" class="main-app">
            <div class="user-info">
                <div class="user-details">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">ç”¨æˆ·</div>
                        <div style="color: #666; font-size: 14px;" id="userEmail">user@example.com</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab(event, 'home')">ğŸ  é¦–é¡µ</button>
                <button class="nav-tab" onclick="showTab(event, 'add')">ğŸ’° è®°è´¦</button>
                <button class="nav-tab" onclick="showTab(event, 'history')">ğŸ“‹ å†å²</button>
                <button class="nav-tab" onclick="showTab(event, 'stats')">ğŸ“Š ç»Ÿè®¡</button>
                <button class="nav-tab" onclick="showTab(event, 'settings')">âš™ï¸ è®¾ç½®</button>
            </div>

            <div class="content">
                <div id="home" class="tab-content">
                    <h2>è´¢åŠ¡æ¦‚è§ˆ</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><h3 id="totalIncome">Â¥0</h3><div>æ€»æ”¶å…¥</div></div>
                        <div class="stat-card"><h3 id="totalExpense">Â¥0</h3><div>æ€»æ”¯å‡º</div></div>
                        <div class="stat-card"><h3 id="balance">Â¥0</h3><div>ä½™é¢</div></div>
                    </div>
                    <h3>æœ€è¿‘äº¤æ˜“</h3>
                    <div id="recentTransactions" class="transaction-list"><p style="text-align:center;color:#666;padding:18px;">æš‚æ— äº¤æ˜“è®°å½•</p></div>
                </div>

                <div id="add" class="tab-content" style="display: none;">
                    <h2>æ·»åŠ äº¤æ˜“</h2>
                    <div class="form-group">
                        <label>ğŸ¤ è¯­éŸ³è¾“å…¥</label>
                        <div style="text-align:center;">
                            <button id="voiceBtn" class="btn" onclick="startVoiceInput()">ğŸ¤ ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥</button>
                        </div>
                        <div id="voiceStatus" class="voice-status"></div>
                    </div>
                    <form id="transactionForm">
                        <div class="form-group"><label>äº¤æ˜“ç±»å‹</label><select id="type" required><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                        <div class="form-group"><label>é‡‘é¢</label><input type="number" id="amount" step="0.01" required placeholder="è¯·è¾“å…¥é‡‘é¢"></div>
                        <div class="form-group"><label>åˆ†ç±»</label><select id="category" required>
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="é¤é¥®">é¤é¥®</option><option value="äº¤é€š">äº¤é€š</option><option value="è´­ç‰©">è´­ç‰©</option><option value="å¨±ä¹">å¨±ä¹</option><option value="åŒ»ç–—">åŒ»ç–—</option><option value="æ•™è‚²">æ•™è‚²</option><option value="å·¥èµ„">å·¥èµ„</option><option value="å¥–é‡‘">å¥–é‡‘</option><option value="æŠ•èµ„">æŠ•èµ„</option><option value="å…¶ä»–">å…¶ä»–</option>
                        </select></div>
                        <div class="form-group"><label>æè¿°</label><textarea id="description" rows="3" placeholder="è¯·è¾“å…¥äº¤æ˜“æè¿°"></textarea></div>
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="date" required></div>
                        <button type="submit" class="btn">æ·»åŠ äº¤æ˜“</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">æ¸…ç©º</button>
                    </form>
                    <h3 style="margin-top:10px;">å¿«é€Ÿæ¨¡æ¿</h3>
                    <div class="quick-templates">
                        <div class="template-btn" onclick="useTemplate('æ—©é¤','expense','é¤é¥®',15)">ğŸ³ æ—©é¤ Â¥15</div>
                        <div class="template-btn" onclick="useTemplate('åˆé¤','expense','é¤é¥®',25)">ğŸ½ï¸ åˆé¤ Â¥25</div>
                        <div class="template-btn" onclick="useTemplate('æ™šé¤','expense','é¤é¥®',30)">ğŸœ æ™šé¤ Â¥30</div>
                        <div class="template-btn" onclick="useTemplate('å·¥èµ„','income','å·¥èµ„',5000)">ğŸ’° å·¥èµ„ Â¥5000</div>
                        <div class="template-btn" onclick="useTemplate('æ‰“è½¦','expense','äº¤é€š',20)">ğŸš— æ‰“è½¦ Â¥20</div>
                        <div class="template-btn" onclick="useTemplate('è´­ç‰©','expense','è´­ç‰©',100)">ğŸ›’ è´­ç‰© Â¥100</div>
                    </div>
                </div>

                <div id="history" class="tab-content" style="display: none;">
                    <h2>äº¤æ˜“å†å²</h2>
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="æœç´¢äº¤æ˜“..." onkeyup="filterTransactions()">
                        <select id="categoryFilter" onchange="filterTransactions()"><option value="">æ‰€æœ‰åˆ†ç±»</option><option value="é¤é¥®">é¤é¥®</option><option value="äº¤é€š">äº¤é€š</option><option value="è´­ç‰©">è´­ç‰©</option><option value="å¨±ä¹">å¨±ä¹</option><option value="åŒ»ç–—">åŒ»ç–—</option><option value="æ•™è‚²">æ•™è‚²</option><option value="å·¥èµ„">å·¥èµ„</option><option value="å¥–é‡‘">å¥–é‡‘</option><option value="æŠ•èµ„">æŠ•èµ„</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                        <select id="typeFilter" onchange="filterTransactions()"><option value="">æ‰€æœ‰ç±»å‹</option><option value="income">æ”¶å…¥</option><option value="expense">æ”¯å‡º</option></select>
                    </div>
                    <div id="transactionList" class="transaction-list"><p style="text-align:center;color:#666;padding:18px;">æš‚æ— äº¤æ˜“è®°å½•</p></div>
                </div>

                <div id="stats" class="tab-content" style="display: none;">
                    <h2>ç»Ÿè®¡åˆ†æ</h2>
                    <canvas id="expenseChart" width="400" height="300"></canvas>
                </div>

                <div id="settings" class="tab-content" style="display: none;">
                    <h2>è®¾ç½®</h2>
                    <div class="section-card">
                        <h3>ç®¡ç†å®‰å…¨é—®é¢˜</h3>
                        <div id="settingsQuestions"></div>
                        <button class="btn btn-secondary" type="button" onclick="addSettingsQuestionItem()">æ·»åŠ é—®é¢˜</button>
                        <button class="btn" type="button" onclick="saveSettingsQuestions()">ä¿å­˜é—®é¢˜ä¸ç­”æ¡ˆ</button>
                    </div>
                    <div class="section-card">
                        <h3>è´¦æˆ·ä¿¡æ¯</h3>
                        <p>ç”¨æˆ·å: <span id="settingsUsername"></span></p>
                        <p>æ³¨å†Œæ—¶é—´: <span id="settingsRegisterTime"></span></p>
                    </div>
                    <div class="section-card">
                        <h3>æ•°æ®ç®¡ç†</h3>
                        <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-secondary" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                        <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    </div>
                    <div class="section-card">
                        <h3>â˜ï¸ è‡ªåŠ¨äº‘åŒæ­¥ï¼ˆè·¨è®¾å¤‡ï¼‰</h3>
                        <p class="hint" style="margin-bottom: 12px;">å¼€å¯åè‡ªåŠ¨åŒæ­¥æ•°æ®åˆ°äº‘ç«¯ï¼Œæ‰€æœ‰è®¾å¤‡è‡ªåŠ¨åŒæ­¥ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ</p>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>å¯ç”¨è‡ªåŠ¨åŒæ­¥</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>GitHub Token</label>
                            <input type="password" id="githubToken" placeholder="è¾“å…¥æ‚¨çš„ GitHub Personal Access Token" style="font-size: 13px;">
                            <div class="hint" style="margin-top: 4px;">
                                <a href="https://github.com/settings/tokens/new?scopes=gist&description=è®°è´¦åŠ©æ‰‹åŒæ­¥" target="_blank" style="color: #4CAF50;">ç‚¹å‡»è¿™é‡Œåˆ›å»º Token</a>
                                ï¼ˆåªéœ€å‹¾é€‰ <span style="background:#f0f0f0;padding:2px 6px;border-radius:3px;font-family:monospace;">gist</span> æƒé™ï¼‰
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="saveGithubToken()" style="flex: 1; min-width: 140px;">ä¿å­˜ Token</button>
                            <button class="btn" onclick="manualSyncNow()" style="flex: 1; min-width: 140px;">ğŸ”„ ç«‹å³åŒæ­¥</button>
                        </div>
                        <div id="syncStatus" style="margin-top: 10px; font-size: 13px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let currentUser = null;
        let transactions = [];
        let recognition = null;
        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        class UserManager {
            constructor(){
                this.users = JSON.parse(localStorage.getItem('users')) || [];
                this.currentUser = null;
            }
            register(username, password, securityQAs) {
                if(this.users.find(u=>u.username===username)) throw new Error('ç”¨æˆ·åå·²å­˜åœ¨');
                const newUser = {
                    id: Date.now(),
                    username,
                    password: this.hashPassword(password),
                    registerTime: new Date().toISOString(),
                    transactions: [],
                    securityQA: (securityQAs||[]).map(q=>({ q: q.q, aHash: this.hashPassword(this.normalizeAnswer(q.a)) })),
                };
                this.users.push(newUser);
                localStorage.setItem('users', JSON.stringify(this.users));
                return newUser;
            }
            login(username, password) {
                const user = this.users.find(u=>u.username === username);
                if(!user) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
                if(user.password !== this.hashPassword(password)) throw new Error('å¯†ç é”™è¯¯');
                this.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                return user;
            }
            logout(){ this.currentUser=null; localStorage.removeItem('currentUser'); }
            getCurrentUser(){
                if(!this.currentUser){
                    const saved = localStorage.getItem('currentUser');
                    if(saved) this.currentUser = JSON.parse(saved);
                }
                return this.currentUser;
            }
            updateUser(userData){
                const userIndex = this.users.findIndex(u => u.id === this.currentUser.id);
                if(userIndex !== -1){
                    this.users[userIndex] = { ...this.users[userIndex], ...userData };
                    this.currentUser = this.users[userIndex];
                    localStorage.setItem('users', JSON.stringify(this.users));
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
            }
            hashPassword(password){ return btoa(unescape(encodeURIComponent(password+'salt'))); }
            normalizeAnswer(a){ return (a||'').trim().toLowerCase(); }
            getUserTransactions(){ return this.currentUser ? (this.currentUser.transactions||[]) : []; }
            saveUserTransactions(ts){ if(this.currentUser) { this.currentUser.transactions = ts; this.updateUser({ transactions: ts }); } }
        }
        const userManager = new UserManager();

        // å®‰å…¨é—®é¢˜ï¼ˆæ³¨å†Œä¸è®¾ç½®ï¼‰
        function initSecurityQuestionUI(){ addSecurityQuestionItem(); }
        function addSecurityQuestionItem(){ const c=$('securityQuestionsContainer'); const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>é—®é¢˜</label><input type="text" placeholder="ä¾‹å¦‚ï¼šæˆ‘å°å­¦çš„åå­—ï¼Ÿ"></div><div class="form-group"><label>ç­”æ¡ˆ</label><input type="text" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"></div>`; c.appendChild(row); }
        function collectSecurityQuestions(containerSel){ const rows=document.querySelectorAll(containerSel+' .form-row'); const list=[]; rows.forEach(r=>{ const q=r.querySelector('input[placeholder^="ä¾‹å¦‚"]')?.value?.trim(); const a=r.querySelector('input[placeholder^="è¯·è¾“å…¥ç­”æ¡ˆ"]')?.value?.trim(); if(q&&a){ list.push({ q, a }); } }); return list; }

        function renderResetSecurityArea(){ const username=$('resetUsername').value; const user=userManager.users.find(u=>u.username===username); const area=$('resetSecurityDynamicArea'); if(!user){ area.innerHTML='<span class="hint">æœªæ‰¾åˆ°è¯¥ç”¨æˆ·ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å</span>'; return; } if(!user.securityQA || user.securityQA.length===0){ area.innerHTML='<span class="hint">è¯¥ç”¨æˆ·æœªè®¾ç½®å®‰å…¨é—®é¢˜ï¼Œæ— æ³•ä½¿ç”¨è¯¥æ–¹å¼æ‰¾å›</span>'; return; }
            area.innerHTML = user.securityQA.map((qa,idx)=>`<div class="form-group"><label>é—®é¢˜${idx+1}</label><input type="text" value="${qa.q}" disabled><label class="hint">ç­”æ¡ˆ</label><input type="text" data-q="${qa.q}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"></div>`).join('') + '<div class="hint">ä»»æ„ä¸€é“ç­”æ¡ˆæ­£ç¡®å³å¯é€šè¿‡</div>';
        }
        function collectSecurityAnswers(containerSel){ const inputs=document.querySelectorAll(containerSel+' input[data-q]'); const arr=[]; inputs.forEach(i=>{ const q=i.getAttribute('data-q'); const a=(i.value||'').trim(); if(a) arr.push({ q, a }); }); return arr; }

        // æœ¬åœ°éªŒè¯ç ï¼ˆå‘é€æ¨¡æ‹Ÿï¼‰
        

        // è®¾ç½®é¡µï¼šå®‰å…¨ä¸æ¢å¤
        function initSettingsSecurity(user){ renderSettingsQuestions(user); }
        function renderSettingsQuestions(user){ const c=$('settingsQuestions'); c.innerHTML=''; (user.securityQA||[]).forEach(qa=>{ const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>é—®é¢˜</label><input type="text" value="${qa.q}" placeholder="é—®é¢˜"></div><div class="form-group"><label>ç­”æ¡ˆï¼ˆä¿®æ”¹æ—¶éœ€é‡å¡«ï¼‰</label><input type="text" placeholder="ç­”æ¡ˆ"></div>`; c.appendChild(row); }); if((user.securityQA||[]).length===0){ addSettingsQuestionItem(); } }
        function addSettingsQuestionItem(){ const c=$('settingsQuestions'); const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>é—®é¢˜</label><input type="text" placeholder="é—®é¢˜"></div><div class="form-group"><label>ç­”æ¡ˆ</label><input type="text" placeholder="ç­”æ¡ˆ"></div>`; c.appendChild(row); }
        function saveSettingsQuestions(){ if(!currentUser) return; const rows=$$('#settingsQuestions .form-row'); const list=[]; rows.forEach(r=>{ const q=r.querySelector('input[placeholder^="é—®é¢˜"]')?.value?.trim(); const a=r.querySelector('input[placeholder^="ç­”æ¡ˆ"]')?.value?.trim(); if(q && a){ list.push({ q, a }); } }); userManager.updateUser({ securityQA: list.map(x=>({ q:x.q, aHash: userManager.hashPassword(userManager.normalizeAnswer(x.a)) })) }); toast('å®‰å…¨é—®é¢˜å·²ä¿å­˜','success'); renderSettingsQuestions(userManager.currentUser); autoSyncToCloud(true); }

        // æœ¬åœ°äºŒæ­¥éªŒè¯ç 
        // åˆ é™¤ refreshLocalOtpã€startOtpTickerã€showLocalOtpHelp åŠæ‰€æœ‰ userManager.generateOtpç›¸å…³ä»£ç 
        // åˆ é™¤è®¾ç½®tabä¸­å¯¹åŠ¨æ€ç ã€äºŒæ­¥éªŒè¯ç›¸å…³çš„ä»»ä½•åˆ·æ–°å‡½æ•°æˆ–å‰ç«¯UIè°ƒç”¨

        // æç¤º/é”å®šä¿¡æ¯
        function updateLockHint(u){ if(!u) return; if(u.login && u.login.lockedUntil){ const now=Date.now(); if(now < u.login.lockedUntil){ const left = Math.ceil((u.login.lockedUntil - now)/60000); $('lockHint').style.display='block'; $('lockHint').textContent = `è´¦æˆ·å·²è¢«é”å®šï¼Œçº¦ ${left} åˆ†é’Ÿåå¯å†æ¬¡å°è¯•ç™»å½•`; return; } }
            $('lockHint').style.display='none'; }

        // ç®€å•å·¥å…·
        function $(id){ return document.getElementById(id); }
        function $$(sel){ return Array.from(document.querySelectorAll(sel)); }
        function toast(message,type){ const existing=document.querySelector('.error-message, .success-message'); if(existing) existing.remove(); const div=document.createElement('div'); div.className= type==='error'?'error-message':'success-message'; div.textContent=message; const activeForm= document.querySelector('#authContainer .auth-form:not([style*="display: none"])'); (activeForm||document.querySelector('#authContainer')).insertBefore(div,(activeForm||document.querySelector('#authContainer')).firstChild); setTimeout(()=>{ div.remove(); }, 3200); }
        function logout(){ if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')){ userManager.logout(); document.getElementById('authContainer').style.display='flex'; document.getElementById('mainApp').classList.remove('show'); document.getElementById('loginFormElement').reset(); document.getElementById('registerFormElement').reset(); document.getElementById('resetFormElement').reset(); } }

        // è¯­éŸ³
        function initSpeechRecognition(){ if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){ const SR= window.SpeechRecognition||window.webkitSpeechRecognition; recognition=new SR(); recognition.continuous=false; recognition.interimResults=false; recognition.lang='zh-CN'; recognition.onstart=function(){ setVoiceStatus('listening','ğŸ¤ æ­£åœ¨å¬å–æ‚¨çš„è¯­éŸ³...'); }; recognition.onresult=function(e){ const t=e.results[0][0].transcript; setVoiceStatus('processing','ğŸ”„ æ­£åœ¨å¤„ç†è¯­éŸ³å†…å®¹...'); setTimeout(()=>{ const r=parseVoiceInput(t); if(r){ $('type').value=r.type; $('amount').value=r.amount; $('category').value=r.category; $('description').value=r.description; setVoiceStatus('success',`âœ… å·²è¯†åˆ«: ${r.description} ${r.amount}å…ƒ`); showTab(null,'add'); } else { setVoiceStatus('error','âŒ æ— æ³•è¯†åˆ«è¯­éŸ³å†…å®¹ï¼Œè¯·é‡è¯•'); } }, 600); }; recognition.onerror=function(ev){ setVoiceStatus('error','âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥: '+ev.error); }; recognition.onend=function(){ setTimeout(()=>{ $('voiceStatus').style.display='none'; },1500); }; } }
        function startVoiceInput(){ 
            if(!recognition){ 
                const msg = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½\n\n' +
                    'æç¤ºï¼š\n' +
                    '1. è¯·ä½¿ç”¨ Chromeã€Edge æˆ– Safari æµè§ˆå™¨\n' +
                    '2. ç¡®ä¿ç½‘ç«™ä½¿ç”¨ HTTPS åè®®ï¼ˆGitHub Pages å·²æ»¡è¶³ï¼‰\n' +
                    '3. å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™\n' +
                    '4. å¦‚ä»æ— æ³•ä½¿ç”¨ï¼Œè¯·å°è¯•æ‰‹åŠ¨è¾“å…¥';
                alert(msg); 
                return; 
            } 
            try {
                recognition.start();
            } catch(e) {
                setVoiceStatus('error', 'âŒ è¯·å…ˆå…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™');
                setTimeout(() => {
                    $('voiceStatus').style.display = 'none';
                }, 2000);
            }
        }
        function setVoiceStatus(type,msg){ const d=$('voiceStatus'); d.className='voice-status '+type; d.textContent=msg; d.style.display='block'; }
        function parseVoiceInput(text){ const clean=text.replace(/[ï¼Œã€‚ï¼ï¼Ÿ\s]/g,''); const m=clean.match(/(\d+(?:\.\d+)?)å…ƒ?/); if(!m) return null; const amount=parseFloat(m[1]); let type='expense', category='å…¶ä»–', description=clean; if(clean.includes('å·¥èµ„')||clean.includes('æ”¶å…¥')||clean.includes('å¥–é‡‘')){ type='income'; if(clean.includes('å·¥èµ„')) category='å·¥èµ„'; else if(clean.includes('å¥–é‡‘')) category='å¥–é‡‘'; else category='å…¶ä»–'; } else { if(clean.includes('æ—©é¤')||clean.includes('åˆé¤')||clean.includes('æ™šé¤')||clean.includes('åƒé¥­')||clean.includes('é¤é¥®')) category='é¤é¥®'; else if(clean.includes('æ‰“è½¦')||clean.includes('äº¤é€š')||clean.includes('åœ°é“')||clean.includes('å…¬äº¤')||clean.includes('å‡ºç§Ÿè½¦')) category='äº¤é€š'; else if(clean.includes('è´­ç‰©')||clean.includes('è¶…å¸‚')||clean.includes('å•†åœº')) category='è´­ç‰©'; else if(clean.includes('å¨±ä¹')||clean.includes('ç”µå½±')||clean.includes('æ¸¸æˆ')) category='å¨±ä¹'; else if(clean.includes('åŒ»ç–—')||clean.includes('åŒ»é™¢')||clean.includes('è¯')) category='åŒ»ç–—'; else if(clean.includes('æ•™è‚²')||clean.includes('å­¦è´¹')||clean.includes('ä¹¦')) category='æ•™è‚²'; }
            return { type, amount, category, description }; }

        // é¡µé¢åˆ‡æ¢ä¸æ•°æ®
        function showTab(e,tab){
            document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
            document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
            if(tab){
                document.getElementById(tab).style.display='block';
                if(e&&e.target) e.target.classList.add('active');
                else {
                    const btnMap={home:0,add:1,history:2,stats:3,settings:4};
                    const btns=document.querySelectorAll('.nav-tab');
                    const idx=btnMap[tab];
                    if(btns[idx]) btns[idx].classList.add('active');
                }
                if(tab==='history') displayTransactions();
                if(tab==='stats') drawCharts();
                if(tab==='settings') {
                    if(currentUser) {
                        $('settingsUsername').textContent = currentUser.username;
                        $('settingsRegisterTime').textContent = currentUser.registerTime ? new Date(currentUser.registerTime).toLocaleString('zh-CN') : 'æœªçŸ¥';
                        renderSettingsQuestions(currentUser);
                        loadGithubTokenDisplay();
                    }
                }
            }
        }
        document.getElementById('transactionForm').addEventListener('submit', function(e){ e.preventDefault(); const t={ id:Date.now(), type:$('type').value, amount:parseFloat($('amount').value), category:$('category').value, description:$('description').value, date:$('date').value }; transactions.unshift(t); userManager.saveUserTransactions(transactions); updateStats(); updateRecentTransactions(); clearForm(); alert('äº¤æ˜“æ·»åŠ æˆåŠŸï¼'); autoSyncToCloud(true); });
        function useTemplate(description,type,category,amount){ $('type').value=type; $('amount').value=amount; $('category').value=category; $('description').value=description; }
        function clearForm(){ $('transactionForm').reset(); $('date').value=new Date().toISOString().split('T')[0]; }
        function updateStats(){ const inc=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0); const exp=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0); const bal=inc-exp; $('totalIncome').textContent=`Â¥${inc.toFixed(2)}`; $('totalExpense').textContent=`Â¥${exp.toFixed(2)}`; $('balance').textContent=`Â¥${bal.toFixed(2)}`; }
        function updateRecentTransactions(){ const c=$('recentTransactions'); const recent=transactions.slice(0,5); if(recent.length===0){ c.innerHTML='<p style="text-align:center;color:#666;padding:18px;">æš‚æ— äº¤æ˜“è®°å½•</p>'; return; } c.innerHTML=recent.map(t=>`<div class="transaction-item"><div><div><strong>${t.description}</strong></div><div style=\"color:#666;font-size:0.9rem;\">${t.category} â€¢ ${t.date}</div></div><div class="transaction-amount ${t.type}">${t.type==='income'?'+':'-'}Â¥${t.amount.toFixed(2)}</div></div>`).join(''); }
        // ä¿®æ”¹å†å²åˆ—è¡¨æ¸²æŸ“ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®
        function displayTransactions() {
            const listDiv = document.getElementById('transactionList');
            if (transactions.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color: #666; padding: 20px;">æš‚æ— äº¤æ˜“è®°å½•</p>';
                return;
            }
            listDiv.innerHTML = transactions.map((t, idx) => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div style="font-size:1.12em;"><strong>${t.description}</strong></div>
                        <div style="color: #666; font-size: 0.96em;">${t.category} â€¢ ${t.date}</div>
                    </div>
                    <div class="transaction-amount ${t.type}" style="font-weight:600;">${t.type === 'income' ? '+' : '-'}Â¥${t.amount.toFixed(2)}</div>
                    <button class="delete-btn" onclick="deleteTransaction(${t.id})" title="åˆ é™¤">
                      <svg class="delete-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3a3 3 0 0 1 6 0v1h5v2h-1v13a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V6H4V4h5V3Zm2 1v1h2V4a1 1 0 1 0-2 0ZM7 6v13a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6H7Zm2 3h2v8h-2V9Zm4 0h-2v8h2V9Z"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        // åˆ é™¤æµæ°´
        function deleteTransaction(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•è®°å½•å—ï¼Ÿ')) return;
            transactions = transactions.filter(t => t.id !== id);
            userManager.saveUserTransactions(transactions);
            updateStats();
            updateRecentTransactions();
            displayTransactions();
            autoSyncToCloud(true);
        }
        function filterTransactions(){ const s=($('searchInput').value||'').toLowerCase(); const cf=$('categoryFilter').value; const tf=$('typeFilter').value; const filtered=transactions.filter(t=>{ const mS=(t.description||'').toLowerCase().includes(s) || (t.category||'').toLowerCase().includes(s); const mC=!cf || t.category===cf; const mT=!tf || t.type===tf; return mS && mC && mT; }); const list=$('transactionList'); if(filtered.length===0){ list.innerHTML='<p style="text-align:center;color:#666;padding:18px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„äº¤æ˜“</p>'; return; } list.innerHTML=filtered.map(t=>`<div class="transaction-item"><div><div><strong>${t.description}</strong></div><div style=\"color:#666;font-size:0.9rem;\">${t.category} â€¢ ${t.date}</div></div><div class="transaction-amount ${t.type}">${t.type==='income'?'+':'-'}Â¥${t.amount.toFixed(2)}</div></div>`).join(''); }
        // æ¢å¤ç»Ÿè®¡åˆ†ææŸ±çŠ¶å›¾
        function drawCharts() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            ctx.clearRect(0, 0, 400, 220);
            const allCategories = Array.from(new Set(transactions.map(t => t.category)));
            const incomeByCat = {}, expenseByCat = {};
            allCategories.forEach(cat=>{incomeByCat[cat]=0; expenseByCat[cat]=0;});
            transactions.forEach(t => {
                if (t.type==='income') incomeByCat[t.category] += t.amount;
                if (t.type==='expense') expenseByCat[t.category] += t.amount;
            });
            if (allCategories.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— åˆ†ç±»æ”¶æ”¯æ•°æ®', 200, 110);
                return;
            }
            const barWidth = 220 / allCategories.length;  // æ€»å®½åº¦220ï¼Œé€‚é…åˆ†ç»„å®½åº¦
            const barGap = 10;
            const baseLeft = 54;
            // è·å–æœ€å¤§æŸ±å­é«˜åº¦
            const maxAmount = Math.max(
                ...allCategories.map(cat => Math.max(incomeByCat[cat], expenseByCat[cat]))
            ) || 1;
            allCategories.forEach((category, i) => {
                const inc = incomeByCat[category] || 0;
                const exp = expenseByCat[category] || 0;
                // ç»˜åˆ¶æ”¶å…¥
                let x = baseLeft + i*barWidth;
                let h = (inc/maxAmount)*120;
                ctx.fillStyle = '#43a047';
                ctx.fillRect(x, 170-h, (barWidth-barGap)/2, h);
                ctx.fillStyle = '#222';
                ctx.font = '15px Arial';
                ctx.textAlign = 'center';
                if(inc>0) ctx.fillText(`+${inc.toFixed(2)}`, x+(barWidth-barGap)/4, 162-h);
                // ç»˜åˆ¶æ”¯å‡º
                x = baseLeft + i*barWidth + (barWidth-barGap)/2;
                h = (exp/maxAmount)*120;
                ctx.fillStyle = '#e53935';
                ctx.fillRect(x, 170-h, (barWidth-barGap)/2, h);
                ctx.fillStyle = '#222';
                if(exp>0) ctx.fillText(`-${exp.toFixed(2)}`, x+(barWidth-barGap)/4, 162-h);
                // æ ‡é¢˜
                ctx.font = '16px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(category, baseLeft+i*barWidth+barWidth/2-5, 202);
            });
            // æ ‡é¢˜é«˜äº®
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#222';
            ctx.fillText('åˆ†ç±»ç»Ÿè®¡', 77, 28);
            // å›¾ä¾‹
            ctx.fillStyle = '#43a047'; ctx.fillRect(286, 40, 18, 18);
            ctx.fillStyle = '#222'; ctx.font = '15px Arial'; ctx.textAlign = 'left'; ctx.fillText('æ”¶å…¥', 310, 52);
            ctx.fillStyle = '#e53935'; ctx.fillRect(286, 68, 18, 18);
            ctx.fillStyle = '#222'; ctx.fillText('æ”¯å‡º', 310, 81);
        }
        // [Excel å¯¼å‡º]
        function exportData() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['ç±»å‹', 'é‡‘é¢', 'åˆ†ç±»', 'æè¿°', 'æ—¥æœŸ']
            ];
            transactions.forEach(t => {
                wsData.push([
                    t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                    t.amount,
                    t.category,
                    t.description,
                    t.date
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'æµæ°´');
            XLSX.writeFile(wb, `${currentUser.username}_è®°è´¦æ•°æ®_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        // [Excel å¯¼å…¥]
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        try{
                            const data = ev.target.result;
                            const workbook = XLSX.read(data, {type:'binary'});
                            const wsName = workbook.SheetNames[0];
                            const ws = workbook.Sheets[wsName];
                            const rows = XLSX.utils.sheet_to_json(ws, {header:1,defval:''});
                            // è§£æå¹¶éªŒè¯
                            let colIdx = {
                                ç±»å‹: -1, é‡‘é¢: -1, åˆ†ç±»: -1, æè¿°: -1, æ—¥æœŸ: -1
                            };
                            rows[0].forEach((h,i)=>{if(h in colIdx) colIdx[h]=i;});
                            if(Object.values(colIdx).some(idx=>idx===-1)){ alert('Excelè¡¨å¤´å¿…é¡»åŒ…å«ï¼šç±»å‹ã€é‡‘é¢ã€åˆ†ç±»ã€æè¿°ã€æ—¥æœŸ'); return; }
                            const addList = [];
                            for(let i=1; i<rows.length; i++){
                                const r = rows[i];
                                if(!r[colIdx.é‡‘é¢] || !r[colIdx.ç±»å‹]) continue;
                                addList.push({
                                    id: Date.now() + Math.random(),
                                    type: r[colIdx.ç±»å‹].trim() === 'æ”¶å…¥' ? 'income':'expense',
                                    amount: parseFloat(r[colIdx.é‡‘é¢]) || 0,
                                    category: r[colIdx.åˆ†ç±»]||'å…¶ä»–',
                                    description: r[colIdx.æè¿°]||'',
                                    date: r[colIdx.æ—¥æœŸ]||new Date().toISOString().split('T')[0]
                                });
                            }
                            if(addList.length===0){ alert('æ²¡æœ‰æœ‰æ•ˆæ•°æ®'); return; }
                            // æ’å…¥åˆ°è´¦æœ¬
                            transactions = addList.concat(transactions);
                            userManager.saveUserTransactions(transactions);
                            updateStats();
                            updateRecentTransactions();
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        }catch(e){ alert('æ–‡ä»¶è§£æå¤±è´¥ï¼'); }
                    };
                    reader.readAsBinaryString(file);
                }
            };
            input.click();
        }
        function clearAllData(){ if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')){ transactions=[]; userManager.saveUserTransactions(transactions); updateStats(); updateRecentTransactions(); alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º'); autoSyncToCloud(true); } }
        function clearAllUsers(){
            if(confirm('æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ³¨å†Œç”¨æˆ·ä¸ä¼šè¯ä¿¡æ¯ï¼Œä¸”ä¸å¯æ¢å¤ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){
                try{
                    localStorage.removeItem('users');
                    localStorage.removeItem('currentUser');
                    alert('å·²æ¸…é™¤æ‰€æœ‰æ³¨å†Œè®°å½•ï¼Œç°åœ¨å°†è¿”å›ç™»å½•é¡µ');
                    location.reload();
                }catch(e){
                    alert('æ¸…é™¤å¤±è´¥ï¼š'+ e.message);
                }
            }
        }

        // ========== è‡ªåŠ¨äº‘åŒæ­¥åŠŸèƒ½ï¼ˆåŸºäº GitHub Gistï¼‰ ==========
        const GIST_FILENAME = 'family-accounting-data.json';
        let gistId = localStorage.getItem('gistId') || null;
        let isSyncing = false; // é˜²æ­¢å¹¶å‘åŒæ­¥

        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨åŒæ­¥
        function isAutoSyncEnabled(){
            return localStorage.getItem('autoSyncEnabled') === 'true';
        }

        // åˆ‡æ¢è‡ªåŠ¨åŒæ­¥å¼€å…³
        function toggleAutoSync(){
            const enabled = $('autoSyncEnabled').checked;
            localStorage.setItem('autoSyncEnabled', enabled ? 'true' : 'false');
            if(enabled){
                const token = localStorage.getItem('githubToken');
                if(!token){
                    alert('è¯·å…ˆè®¾ç½® GitHub Tokenï¼');
                    $('autoSyncEnabled').checked = false;
                    localStorage.setItem('autoSyncEnabled', 'false');
                    return;
                }
                toast('è‡ªåŠ¨åŒæ­¥å·²å¼€å¯ï¼Œæ•°æ®å°†è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯','success');
                // ç«‹å³ä¸Šä¼ ä¸€æ¬¡
                autoSyncToCloud(true);
            } else {
                toast('è‡ªåŠ¨åŒæ­¥å·²å…³é—­','success');
            }
        }

        // ä¿å­˜ GitHub Token
        function saveGithubToken(){
            const token = $('githubToken').value.trim();
            if(!token){
                alert('è¯·è¾“å…¥ GitHub Token');
                return;
            }
            localStorage.setItem('githubToken', token);
            $('githubToken').value = '';
            toast('Token å·²ä¿å­˜','success');
            // å¦‚æœå·²å¼€å¯è‡ªåŠ¨åŒæ­¥ï¼Œç«‹å³ä¸Šä¼ 
            if(isAutoSyncEnabled()){
                autoSyncToCloud(true);
            }
        }

        // è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯ï¼ˆé™é»˜æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºç¡®è®¤æ¡†ï¼‰
        async function autoSyncToCloud(silent = false){
            if(isSyncing) return; // é˜²æ­¢å¹¶å‘
            const token = localStorage.getItem('githubToken');
            if(!token || !isAutoSyncEnabled()) return;
            
            isSyncing = true;
            const statusEl = $('syncStatus');
            if(!silent && statusEl){
                statusEl.innerHTML = 'â³ æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...';
                statusEl.style.color = '#f57c00';
            }
            try{
                const allData = {
                    users: userManager.users,
                    syncTime: new Date().toISOString(),
                    version: '1.0'
                };
                const content = JSON.stringify(allData, null, 2);
                const url = gistId 
                    ? `https://api.github.com/gists/${gistId}`
                    : 'https://api.github.com/gists';
                const method = gistId ? 'PATCH' : 'POST';
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'å®¶åº­è®°è´¦åŠ©æ‰‹ - äº‘ç«¯æ•°æ®åŒæ­¥',
                        public: false,
                        files: {
                            [GIST_FILENAME]: {
                                content: content
                            }
                        }
                    })
                });
                if(!response.ok){
                    const error = await response.json();
                    throw new Error(error.message || 'ä¸Šä¼ å¤±è´¥');
                }
                const result = await response.json();
                gistId = result.id;
                localStorage.setItem('gistId', gistId);
                if(statusEl){
                    statusEl.innerHTML = 'âœ… è‡ªåŠ¨åŒæ­¥ä¸­...';
                    statusEl.style.color = '#2e7d32';
                }
            }catch(err){
                if(statusEl){
                    statusEl.innerHTML = 'âŒ åŒæ­¥å¤±è´¥: ' + err.message;
                    statusEl.style.color = '#c62828';
                }
                console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', err);
            }finally{
                isSyncing = false;
            }
        }

        // è‡ªåŠ¨ä»äº‘ç«¯ä¸‹è½½ï¼ˆé™é»˜æ¨¡å¼ï¼Œé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
        async function autoSyncFromCloud(silent = false){
            if(isSyncing) return;
            const token = localStorage.getItem('githubToken');
            if(!token || !isAutoSyncEnabled() || !gistId) return;
            
            isSyncing = true;
            try{
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                if(!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
                
                const result = await response.json();
                const file = result.files[GIST_FILENAME];
                if(!file) return;
                
                const cloudData = JSON.parse(file.content);
                if(!cloudData.users || !Array.isArray(cloudData.users)) return;
                
                // æ™ºèƒ½åˆå¹¶ï¼šä»¥äº‘ç«¯æ•°æ®ä¸ºä¸»ï¼Œä½†ä¿ç•™æœ¬åœ°æ–°å¢çš„ç”¨æˆ·
                const localUsers = userManager.users;
                const cloudUsers = cloudData.users;
                const userMap = new Map();
                
                // å…ˆæ·»åŠ æ‰€æœ‰äº‘ç«¯ç”¨æˆ·
                cloudUsers.forEach(u => userMap.set(u.username, u));
                // å†æ·»åŠ æœ¬åœ°ç‹¬æœ‰çš„ç”¨æˆ·
                localUsers.forEach(localUser => {
                    if(!userMap.has(localUser.username)){
                        userMap.set(localUser.username, localUser);
                    }
                });
                
                const mergedUsers = Array.from(userMap.values());
                userManager.users = mergedUsers;
                localStorage.setItem('users', JSON.stringify(mergedUsers));
                
                // æ›´æ–°å½“å‰ç”¨æˆ·æ•°æ®
                if(currentUser){
                    const updatedUser = mergedUsers.find(u => u.username === currentUser.username);
                    if(updatedUser){
                        currentUser = updatedUser;
                        transactions = userManager.getUserTransactions();
                        userManager.currentUser = updatedUser;
                        localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                        updateStats();
                        updateRecentTransactions();
                    }
                }
                
                if(!silent && $('syncStatus')){
                    $('syncStatus').innerHTML = 'âœ… å·²ä»äº‘ç«¯åŒæ­¥æœ€æ–°æ•°æ®';
                    $('syncStatus').style.color = '#2e7d32';
                }
            }catch(err){
                console.error('è‡ªåŠ¨ä¸‹è½½å¤±è´¥:', err);
                if(!silent && $('syncStatus')){
                    $('syncStatus').innerHTML = 'âš ï¸ åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
                    $('syncStatus').style.color = '#f57c00';
                }
            }finally{
                isSyncing = false;
            }
        }

        // ç«‹å³åŒæ­¥ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        async function manualSyncNow(){
            const token = localStorage.getItem('githubToken');
            if(!token){
                alert('è¯·å…ˆè®¾ç½® GitHub Tokenï¼');
                return;
            }
            const statusEl = $('syncStatus');
            statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨åŒæ­¥...';
            statusEl.style.color = '#f57c00';
            
            // å…ˆä¸‹è½½
            await autoSyncFromCloud(false);
            // å†ä¸Šä¼ 
            await autoSyncToCloud(false);
            
            setTimeout(() => {
                statusEl.innerHTML = 'âœ… åŒæ­¥å®Œæˆ';
                statusEl.style.color = '#2e7d32';
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå·²ä¿å­˜çš„è®¾ç½®
        function loadGithubTokenDisplay(){
            const token = localStorage.getItem('githubToken');
            if(token){
                $('githubToken').placeholder = `å·²è®¾ç½® Token: ${token.substring(0, 4)}****ï¼ˆç‚¹å‡»è¾“å…¥æ¡†å¯ä¿®æ”¹ï¼‰`;
            }
            const autoSync = isAutoSyncEnabled();
            if($('autoSyncEnabled')){
                $('autoSyncEnabled').checked = autoSync;
            }
            const savedGistId = localStorage.getItem('gistId');
            if(savedGistId && $('syncStatus')){
                const status = autoSync ? 'âœ… è‡ªåŠ¨åŒæ­¥å·²å¼€å¯' : 'ğŸ“Œ è‡ªåŠ¨åŒæ­¥å·²å…³é—­';
                $('syncStatus').innerHTML = status + ' | Gist: ' + savedGistId.substring(0, 8) + '...';
                $('syncStatus').style.color = autoSync ? '#2e7d32' : '#666';
            }
        }

        // Tabåˆ‡æ¢ä¿®å¤ï¼Œå®ç°tabå¯åˆ‡æ¢ç™»å½•/æ³¨å†Œ/æ‰¾å›
        function showAuthTab(event, tab) {
            document.querySelectorAll('.auth-tab').forEach(btn=>btn.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            document.getElementById('loginForm').style.display = tab==='login' ? 'block':'none';
            document.getElementById('registerForm').style.display = tab==='register' ? 'block':'none';
            document.getElementById('resetForm').style.display = tab==='reset' ? 'block':'none';
        }
        function showAuthTabByName(tab) {
            document.querySelectorAll('.auth-tab').forEach(btn=>{
                if(btn.dataset.tab === tab) btn.click();
            });
        }

        // ä¸»åº”ç”¨æ˜¾ç¤º
        function showMainApp(user){
            document.getElementById('authContainer').style.display='none';
            document.getElementById('mainApp').classList.add('show');
            document.getElementById('userAvatar').textContent=user.username.charAt(0).toUpperCase();
            document.getElementById('userName').textContent=user.username;
            document.getElementById('userEmail').textContent=user.username+'@example.com'; // ç¤ºä¾‹é‚®ç®±
            // æ˜¾ç¤ºæ‰€æœ‰ä¸»åº”ç”¨tabå†…å®¹
            document.querySelectorAll('.nav-tab').forEach(tabBtn=>{
                tabBtn.classList.remove('active');
                if(tabBtn.textContent.includes('é¦–é¡µ')) tabBtn.classList.add('active');
            });
            document.querySelectorAll('.tab-content').forEach(tabContent=>{
                tabContent.style.display='none';
            });
            document.getElementById('home').style.display='block';
            updateStats();
            updateRecentTransactions();
            // -- åˆ é™¤ refreshLocalOtp --
            // refreshLocalOtp();
        }

        // ç™»å½•è¡¨å•äº‹ä»¶ä¿®æ­£
        document.getElementById('loginFormElement').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            try{
                const user = userManager.login(username, password);
                currentUser = user;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // è‡ªåŠ¨ä»äº‘ç«¯åŒæ­¥ï¼ˆå¦‚æœæœ‰å¼€å¯ï¼‰
                await autoSyncFromCloud(true);
                // åŒæ­¥åå†ä¸Šä¼ ï¼ˆç¡®ä¿æœ¬åœ°æœ€æ–°æ•°æ®ä¹Ÿåœ¨äº‘ç«¯ï¼‰
                autoSyncToCloud(true);
            }catch(err){
                alert(err.message);
            }
        });
        // æ³¨å†Œè¡¨å•äº‹ä»¶ä¿®æ­£
        document.getElementById('registerFormElement').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            if(password !== confirm){ alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'); return; }
            if(password.length < 6){ alert('å¯†ç é•¿åº¦è‡³å°‘6ä½'); return; }
            const securityQAs = collectSecurityQuestions('#securityQuestionsContainer');
            try{
                // æ³¨å†Œå‰å…ˆåŒæ­¥äº‘ç«¯æ•°æ®ï¼ˆä»¥é˜²å…¶ä»–è®¾å¤‡æœ‰æ–°ç”¨æˆ·ï¼‰
                await autoSyncFromCloud(true);
                const user = userManager.register(username, password, securityQAs);
                currentUser = user;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // æ³¨å†Œåè‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
                autoSyncToCloud(true);
            }catch(err){
                alert(err.message);
            }
        });
        // æ‰¾å›å¯†ç è¡¨å•äº‹ä»¶ä¿®æ­£ï¼ˆå‡å®šå®ç°å·²ç»æœ‰resetPasswordæ–¹æ³•ï¼‰
        if(document.getElementById('resetFormElement')){
        document.getElementById('resetFormElement').addEventListener('submit', function(e){
            e.preventDefault();
            const username = document.getElementById('resetUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;
            const answers = collectSecurityAnswers('#resetSecurityDynamicArea');
            if(newPassword !== confirm){ alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´'); return; }
            if(newPassword.length < 6){ alert('å¯†ç é•¿åº¦è‡³å°‘6ä½'); return; }
            try{
                // åªè¦ä»»æ„ä¸€é“å®‰å…¨é—®é¢˜ç­”æ¡ˆå¯¹åº”å³å¯é‡ç½®
                const user = userManager.users.find(u=>u.username === username);
                if(!user){ alert('ç”¨æˆ·ä¸å­˜åœ¨'); return; }
                if(!user.securityQA || !answers.length){ alert('è¯·å¡«å†™æ­£ç¡®çš„å®‰å…¨é—®é¢˜ç­”æ¡ˆ'); return; }
                let ok = false;
                for(const ans of answers){
                    const found = user.securityQA.find(q=>q.q === ans.q);
                    if(found && found.aHash === userManager.hashPassword(userManager.normalizeAnswer(ans.a))){ ok = true; break; }
                }
                if(!ok){ alert('å®‰å…¨é—®é¢˜ç­”æ¡ˆä¸æ­£ç¡®'); return; }
                user.password = userManager.hashPassword(newPassword);
                localStorage.setItem('users', JSON.stringify(userManager.users));
                // å¯†ç é‡ç½®åè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
                autoSyncToCloud(true);
                alert('å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ç™»å½•ï¼');
                showAuthTabByName('login');
            }catch(err){
                alert('é‡ç½®å¤±è´¥:'+err.message);
            }
        });
        }

        // æ‰¾å›å¯†ç é¡µï¼šç”¨æˆ·åè¾“å…¥æ—¶åŠ¨æ€æ˜¾ç¤ºå®‰å…¨é—®é¢˜
        document.getElementById('resetUsername').addEventListener('blur', function(){
            renderResetSecurityArea();
        });

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function(){
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();
            // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
            clearForm();
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = userManager.getCurrentUser();
            if(savedUser){
                currentUser = savedUser;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // å¦‚æœå¼€å¯äº†è‡ªåŠ¨åŒæ­¥ï¼Œé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ä»äº‘ç«¯ä¸‹è½½æœ€æ–°æ•°æ®
                await autoSyncFromCloud(true);
                // ä¸‹è½½åç«‹å³ä¸Šä¼ ï¼Œç¡®ä¿äº‘ç«¯æœ‰æœ€æ–°æ•°æ®
                autoSyncToCloud(true);
            }
            // åˆå§‹åŒ–æ³¨å†Œé¡µå®‰å…¨é—®é¢˜
            initSecurityQuestionUI();
            // åŠ è½½ GitHub Token æ˜¾ç¤º
            loadGithubTokenDisplay();
        });
    </script>
</body>
</html>
