<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭记账助手 - 多用户安全加强版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 17px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
        .header { text-align: center; color: white; margin-bottom: 32px; }
        .header h1 { font-size: 2.7rem; font-weight: bold; margin-bottom: 4px; text-shadow: 2px 2px 6px rgba(0,0,0,0.23); }
        .header p { font-size: 1.2rem; opacity: 0.93; }
        .main-app .tab-content h2 { font-size: 2rem; font-weight: bold; margin-bottom: 30px; letter-spacing:2px; color: #243d4d; }
        .main-app .tab-content { font-size: 1.1em; }
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 60vh; }
        .auth-card { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; }
        .auth-tabs { display: flex; margin-bottom: 20px; border-radius: 10px; overflow: hidden; background: #f8f9fa; }
        .auth-tab { flex: 1; padding: 12px; cursor: pointer; transition: all 0.3s ease; border: none; background: transparent; font-size: 15px; font-weight: 500; }
        .auth-tab.active { background: #4CAF50; color: white; }
        .auth-tab:hover { background: #45a049; color: white; }
        .form-group { margin-bottom: 14px; text-align: left; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4CAF50; }
        .btn { background: #4CAF50; color: white; border: none; padding: 11px 22px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease; width: 100%; margin-bottom: 12px; }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .inline { display: inline-block; margin-left: 8px; }
        .link { color: #4CAF50; cursor: pointer; text-decoration: underline; font-size: 14px; }
        .hint { color: #666; font-size: 12px; }
        .code-box { display:flex; gap:8px; }
        .code-box input { text-align:center; font-weight:700; letter-spacing:2px; }
        .user-info { background: white; border-radius: 15px; padding: 16px; margin-bottom: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .user-details { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(45deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; }
        .user-name { font-size: 16px; font-weight: 600; color: #333; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .logout-btn:hover { background: #c82333; }
        .main-app { display: none; }
        .main-app.show { display: block; }
        .nav-tabs { display: flex; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
        .nav-tab { flex: 1; padding: 12px 16px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: none; background: white; font-size: 15px; font-weight: 500; }
        .nav-tab.active { background: #4CAF50; color: white; }
        .nav-tab:hover { background: #45a049; color: white; }
        .content { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); min-height: 460px; }
        .voice-status { margin-top: 8px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 500; display: none; }
        .voice-status.listening { background: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; display: block; }
        .voice-status.processing { background: #fff3e0; color: #f57c00; border: 2px solid #ff9800; display: block; }
        .voice-status.success { background: #e8f5e8; color: #2e7d32; border: 2px solid #4caf50; display: block; }
        .voice-status.error { background: #ffebee; color: #c62828; border: 2px solid #f44336; display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 18px; }
        .stat-card { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 1.6rem; margin-bottom: 8px; }
        .transaction-list { max-height: 380px; overflow-y: auto; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; }
        .transaction-amount { font-weight: 600; }
        .transaction-amount.income { color: #4CAF50; }
        .transaction-amount.expense { color: #f44336; }
        .quick-templates { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 10px; }
        .template-btn { background: #f8f9fa; border: 2px solid #e0e0e0; padding: 12px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .template-btn:hover { background: #4CAF50; color: white; border-color: #4CAF50; }
        .search-filter { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
        .error-message { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #f44336; }
        .success-message { background: #e8f5e8; color: #2e7d32; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #4caf50; }
        .section-card { border:1px solid #e5e7eb; border-radius:10px; padding:14px; margin-bottom:12px; background:#fafafa; }
        .delete-btn { background: none; border: none; outline: none; cursor: pointer; margin-left: 12px; min-width: 36px; min-height:36px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.18s; }
        .delete-btn:hover { background: #ffeaea; box-shadow: 0 0 6px #e53935aa; }
        .delete-icon { font-size: 21px; width:21px;height:21px; color: #e53935; pointer-events: none; }
        /* 统计分析内容区居中美化 */
        #stats.tab-content { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 350px; }
        #stats > h2 { margin-bottom: 32px; margin-top: 18px; text-align: center; font-size: 2.1rem; color: #203554; }
        #expenseChart { display: block; margin: 0 auto; margin-bottom: 12px; }
        @media (max-width: 768px) { .container { padding: 10px; } .header h1 { font-size: 1.8rem; } .content { padding: 16px; } .nav-tab { padding: 10px; font-size: 14px; } .auth-card { padding: 22px 16px; } .user-info { flex-direction: column; gap: 10px; text-align: center; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 家庭记账助手</h1>
            <p>多用户安全加强版：验证码、二步验证、多题安全问题、冷却机制</p>
        </div>

        <div id="authContainer" class="auth-container">
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="showAuthTab(event, 'login')">登录</button>
                    <button class="auth-tab" data-tab="register" onclick="showAuthTab(event, 'register')">注册</button>
                    <button class="auth-tab" data-tab="reset" onclick="showAuthTab(event, 'reset')">找回密码</button>
                </div>

                <div id="loginForm" class="auth-form">
                    <h2>欢迎回来</h2>
                    <p class="hint" style="margin-bottom: 10px;">连续失败将触发账户冷却</p>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="loginUsername" required placeholder="请输入用户名">
                        </div>
                        <div class="form-group">
                            <label>密码</label>
                            <input type="password" id="loginPassword" required placeholder="请输入密码">
                        </div>
                        <button type="submit" class="btn">登录</button>
                        <div style="text-align:center; margin-top:6px;">
                            <span class="link" onclick="showAuthTabByName('reset')">忘记密码？</span>
                        </div>
                        <div id="lockHint" class="hint" style="display:none; margin-top:8px;"></div>
                    </form>
                </div>

                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2>创建账户</h2>
                    <p class="hint" style="margin-bottom: 10px;">请设置安全问题，便于忘记密码时找回</p>
                    <form id="registerFormElement">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="registerUsername" required placeholder="请输入用户名">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>密码</label>
                                <input type="password" id="registerPassword" required placeholder="请输入密码（至少6位）">
                            </div>
                            <div class="form-group">
                                <label>确认密码</label>
                                <input type="password" id="confirmPassword" required placeholder="请再次输入密码">
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="form-group">
                                <label>安全问题（可添加多题）</label>
                                <div id="securityQuestionsContainer"></div>
                                <button type="button" class="btn btn-secondary" onclick="addSecurityQuestionItem()">添加安全问题</button>
                            </div>
                        </div>

                        <button type="submit" class="btn">注册</button>
                    </form>
                </div>

                <div id="resetForm" class="auth-form" style="display: none;">
                    <h2>找回密码</h2>
                    <p class="hint" style="margin-bottom: 10px;">仅需回答已设置的安全问题（任意一题正确即可）</p>
                    <form id="resetFormElement">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="resetUsername" required placeholder="请输入用户名">
                        </div>

                        <div class="section-card">
                            <div class="form-group">
                                <label>安全问题</label>
                                <div id="resetSecurityDynamicArea" class="hint">填写用户名后将显示对应问题</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>新密码</label>
                                <input type="password" id="newPassword" required placeholder="请输入新密码（至少6位）">
                            </div>
                            <div class="form-group">
                                <label>确认新密码</label>
                                <input type="password" id="confirmNewPassword" required placeholder="请再次输入新密码">
                            </div>
                        </div>
                        <button type="submit" class="btn">重置密码</button>
                        <div style="text-align:center; margin-top:6px;">
                            <span class="link" onclick="showAuthTabByName('login')">返回登录</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="mainApp" class="main-app">
            <div class="user-info">
                <div class="user-details">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">用户</div>
                        <div style="color: #666; font-size: 14px;" id="userEmail">user@example.com</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab(event, 'home')">🏠 首页</button>
                <button class="nav-tab" onclick="showTab(event, 'add')">💰 记账</button>
                <button class="nav-tab" onclick="showTab(event, 'history')">📋 历史</button>
                <button class="nav-tab" onclick="showTab(event, 'stats')">📊 统计</button>
                <button class="nav-tab" onclick="showTab(event, 'settings')">⚙️ 设置</button>
            </div>

            <div class="content">
                <div id="home" class="tab-content">
                    <h2>财务概览</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><h3 id="totalIncome">¥0</h3><div>总收入</div></div>
                        <div class="stat-card"><h3 id="totalExpense">¥0</h3><div>总支出</div></div>
                        <div class="stat-card"><h3 id="balance">¥0</h3><div>余额</div></div>
                    </div>
                    <h3>最近交易</h3>
                    <div id="recentTransactions" class="transaction-list"><p style="text-align:center;color:#666;padding:18px;">暂无交易记录</p></div>
                </div>

                <div id="add" class="tab-content" style="display: none;">
                    <h2>添加交易</h2>
                    <div class="form-group">
                        <label>🎤 语音输入</label>
                        <div style="text-align:center;">
                            <button id="voiceBtn" class="btn" onclick="startVoiceInput()">🎤 点击开始语音输入</button>
                        </div>
                        <div id="voiceStatus" class="voice-status"></div>
                    </div>
                    <form id="transactionForm">
                        <div class="form-group"><label>交易类型</label><select id="type" required><option value="expense">支出</option><option value="income">收入</option></select></div>
                        <div class="form-group"><label>金额</label><input type="number" id="amount" step="0.01" required placeholder="请输入金额"></div>
                        <div class="form-group"><label>分类</label><select id="category" required>
                            <option value="">请选择分类</option>
                            <option value="餐饮">餐饮</option><option value="交通">交通</option><option value="购物">购物</option><option value="娱乐">娱乐</option><option value="医疗">医疗</option><option value="教育">教育</option><option value="工资">工资</option><option value="奖金">奖金</option><option value="投资">投资</option><option value="其他">其他</option>
                        </select></div>
                        <div class="form-group"><label>描述</label><textarea id="description" rows="3" placeholder="请输入交易描述"></textarea></div>
                        <div class="form-group"><label>日期</label><input type="date" id="date" required></div>
                        <button type="submit" class="btn">添加交易</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">清空</button>
                    </form>
                    <h3 style="margin-top:10px;">快速模板</h3>
                    <div class="quick-templates">
                        <div class="template-btn" onclick="useTemplate('早餐','expense','餐饮',15)">🍳 早餐 ¥15</div>
                        <div class="template-btn" onclick="useTemplate('午餐','expense','餐饮',25)">🍽️ 午餐 ¥25</div>
                        <div class="template-btn" onclick="useTemplate('晚餐','expense','餐饮',30)">🍜 晚餐 ¥30</div>
                        <div class="template-btn" onclick="useTemplate('工资','income','工资',5000)">💰 工资 ¥5000</div>
                        <div class="template-btn" onclick="useTemplate('打车','expense','交通',20)">🚗 打车 ¥20</div>
                        <div class="template-btn" onclick="useTemplate('购物','expense','购物',100)">🛒 购物 ¥100</div>
                    </div>
                </div>

                <div id="history" class="tab-content" style="display: none;">
                    <h2>交易历史</h2>
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="搜索交易..." onkeyup="filterTransactions()">
                        <select id="categoryFilter" onchange="filterTransactions()"><option value="">所有分类</option><option value="餐饮">餐饮</option><option value="交通">交通</option><option value="购物">购物</option><option value="娱乐">娱乐</option><option value="医疗">医疗</option><option value="教育">教育</option><option value="工资">工资</option><option value="奖金">奖金</option><option value="投资">投资</option><option value="其他">其他</option></select>
                        <select id="typeFilter" onchange="filterTransactions()"><option value="">所有类型</option><option value="income">收入</option><option value="expense">支出</option></select>
                    </div>
                    <div id="transactionList" class="transaction-list"><p style="text-align:center;color:#666;padding:18px;">暂无交易记录</p></div>
                </div>

                <div id="stats" class="tab-content" style="display: none;">
                    <h2>统计分析</h2>
                    <canvas id="expenseChart" width="400" height="300"></canvas>
                </div>

                <div id="settings" class="tab-content" style="display: none;">
                    <h2>设置</h2>
                    <div class="section-card">
                        <h3>管理安全问题</h3>
                        <div id="settingsQuestions"></div>
                        <button class="btn btn-secondary" type="button" onclick="addSettingsQuestionItem()">添加问题</button>
                        <button class="btn" type="button" onclick="saveSettingsQuestions()">保存问题与答案</button>
                    </div>
                    <div class="section-card">
                        <h3>账户信息</h3>
                        <p>用户名: <span id="settingsUsername"></span></p>
                        <p>注册时间: <span id="settingsRegisterTime"></span></p>
                    </div>
                    <div class="section-card">
                        <h3>数据管理</h3>
                        <button class="btn" onclick="exportData()">导出数据</button>
                        <button class="btn btn-secondary" onclick="importData()">导入数据</button>
                        <button class="btn btn-danger" onclick="clearAllData()">清空所有数据</button>
                    </div>
                    <div class="section-card">
                        <h3>☁️ 自动云同步（跨设备）</h3>
                        <p class="hint" style="margin-bottom: 12px;">开启后自动同步数据到云端，所有设备自动同步，无需手动操作</p>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>启用自动同步</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>GitHub Token</label>
                            <input type="password" id="githubToken" placeholder="输入您的 GitHub Personal Access Token" style="font-size: 13px;">
                            <div class="hint" style="margin-top: 4px;">
                                <a href="https://github.com/settings/tokens/new?scopes=gist&description=记账助手同步" target="_blank" style="color: #4CAF50;">点击这里创建 Token</a>
                                （只需勾选 <span style="background:#f0f0f0;padding:2px 6px;border-radius:3px;font-family:monospace;">gist</span> 权限）
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="saveGithubToken()" style="flex: 1; min-width: 140px;">保存 Token</button>
                            <button class="btn" onclick="manualSyncNow()" style="flex: 1; min-width: 140px;">🔄 立即同步</button>
                        </div>
                        <div id="syncStatus" style="margin-top: 10px; font-size: 13px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let currentUser = null;
        let transactions = [];
        let recognition = null;
        // 用户管理系统
        class UserManager {
            constructor(){
                this.users = JSON.parse(localStorage.getItem('users')) || [];
                this.currentUser = null;
            }
            register(username, password, securityQAs) {
                if(this.users.find(u=>u.username===username)) throw new Error('用户名已存在');
                const newUser = {
                    id: Date.now(),
                    username,
                    password: this.hashPassword(password),
                    registerTime: new Date().toISOString(),
                    transactions: [],
                    securityQA: (securityQAs||[]).map(q=>({ q: q.q, aHash: this.hashPassword(this.normalizeAnswer(q.a)) })),
                };
                this.users.push(newUser);
                localStorage.setItem('users', JSON.stringify(this.users));
                return newUser;
            }
            login(username, password) {
                const user = this.users.find(u=>u.username === username);
                if(!user) throw new Error('用户不存在');
                if(user.password !== this.hashPassword(password)) throw new Error('密码错误');
                this.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                return user;
            }
            logout(){ this.currentUser=null; localStorage.removeItem('currentUser'); }
            getCurrentUser(){
                if(!this.currentUser){
                    const saved = localStorage.getItem('currentUser');
                    if(saved) this.currentUser = JSON.parse(saved);
                }
                return this.currentUser;
            }
            updateUser(userData){
                const userIndex = this.users.findIndex(u => u.id === this.currentUser.id);
                if(userIndex !== -1){
                    this.users[userIndex] = { ...this.users[userIndex], ...userData };
                    this.currentUser = this.users[userIndex];
                    localStorage.setItem('users', JSON.stringify(this.users));
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
            }
            hashPassword(password){ return btoa(unescape(encodeURIComponent(password+'salt'))); }
            normalizeAnswer(a){ return (a||'').trim().toLowerCase(); }
            getUserTransactions(){ return this.currentUser ? (this.currentUser.transactions||[]) : []; }
            saveUserTransactions(ts){ if(this.currentUser) { this.currentUser.transactions = ts; this.updateUser({ transactions: ts }); } }
        }
        const userManager = new UserManager();

        // 安全问题（注册与设置）
        function initSecurityQuestionUI(){ addSecurityQuestionItem(); }
        function addSecurityQuestionItem(){ const c=$('securityQuestionsContainer'); const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>问题</label><input type="text" placeholder="例如：我小学的名字？"></div><div class="form-group"><label>答案</label><input type="text" placeholder="请输入答案"></div>`; c.appendChild(row); }
        function collectSecurityQuestions(containerSel){ const rows=document.querySelectorAll(containerSel+' .form-row'); const list=[]; rows.forEach(r=>{ const q=r.querySelector('input[placeholder^="例如"]')?.value?.trim(); const a=r.querySelector('input[placeholder^="请输入答案"]')?.value?.trim(); if(q&&a){ list.push({ q, a }); } }); return list; }

        function renderResetSecurityArea(){ const username=$('resetUsername').value; const user=userManager.users.find(u=>u.username===username); const area=$('resetSecurityDynamicArea'); if(!user){ area.innerHTML='<span class="hint">未找到该用户，请检查用户名</span>'; return; } if(!user.securityQA || user.securityQA.length===0){ area.innerHTML='<span class="hint">该用户未设置安全问题，无法使用该方式找回</span>'; return; }
            area.innerHTML = user.securityQA.map((qa,idx)=>`<div class="form-group"><label>问题${idx+1}</label><input type="text" value="${qa.q}" disabled><label class="hint">答案</label><input type="text" data-q="${qa.q}" placeholder="请输入答案"></div>`).join('') + '<div class="hint">任意一道答案正确即可通过</div>';
        }
        function collectSecurityAnswers(containerSel){ const inputs=document.querySelectorAll(containerSel+' input[data-q]'); const arr=[]; inputs.forEach(i=>{ const q=i.getAttribute('data-q'); const a=(i.value||'').trim(); if(a) arr.push({ q, a }); }); return arr; }

        // 本地验证码（发送模拟）
        

        // 设置页：安全与恢复
        function initSettingsSecurity(user){ renderSettingsQuestions(user); }
        function renderSettingsQuestions(user){ const c=$('settingsQuestions'); c.innerHTML=''; (user.securityQA||[]).forEach(qa=>{ const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>问题</label><input type="text" value="${qa.q}" placeholder="问题"></div><div class="form-group"><label>答案（修改时需重填）</label><input type="text" placeholder="答案"></div>`; c.appendChild(row); }); if((user.securityQA||[]).length===0){ addSettingsQuestionItem(); } }
        function addSettingsQuestionItem(){ const c=$('settingsQuestions'); const row=document.createElement('div'); row.className='form-row'; row.innerHTML=`<div class="form-group"><label>问题</label><input type="text" placeholder="问题"></div><div class="form-group"><label>答案</label><input type="text" placeholder="答案"></div>`; c.appendChild(row); }
        function saveSettingsQuestions(){ if(!currentUser) return; const rows=$$('#settingsQuestions .form-row'); const list=[]; rows.forEach(r=>{ const q=r.querySelector('input[placeholder^="问题"]')?.value?.trim(); const a=r.querySelector('input[placeholder^="答案"]')?.value?.trim(); if(q && a){ list.push({ q, a }); } }); userManager.updateUser({ securityQA: list.map(x=>({ q:x.q, aHash: userManager.hashPassword(userManager.normalizeAnswer(x.a)) })) }); toast('安全问题已保存','success'); renderSettingsQuestions(userManager.currentUser); autoSyncToCloud(true); }

        // 本地二步验证码
        // 删除 refreshLocalOtp、startOtpTicker、showLocalOtpHelp 及所有 userManager.generateOtp相关代码
        // 删除设置tab中对动态码、二步验证相关的任何刷新函数或前端UI调用

        // 提示/锁定信息
        function updateLockHint(u){ if(!u) return; if(u.login && u.login.lockedUntil){ const now=Date.now(); if(now < u.login.lockedUntil){ const left = Math.ceil((u.login.lockedUntil - now)/60000); $('lockHint').style.display='block'; $('lockHint').textContent = `账户已被锁定，约 ${left} 分钟后可再次尝试登录`; return; } }
            $('lockHint').style.display='none'; }

        // 简单工具
        function $(id){ return document.getElementById(id); }
        function $$(sel){ return Array.from(document.querySelectorAll(sel)); }
        function toast(message,type){ const existing=document.querySelector('.error-message, .success-message'); if(existing) existing.remove(); const div=document.createElement('div'); div.className= type==='error'?'error-message':'success-message'; div.textContent=message; const activeForm= document.querySelector('#authContainer .auth-form:not([style*="display: none"])'); (activeForm||document.querySelector('#authContainer')).insertBefore(div,(activeForm||document.querySelector('#authContainer')).firstChild); setTimeout(()=>{ div.remove(); }, 3200); }
        function logout(){ if(confirm('确定要退出登录吗？')){ userManager.logout(); document.getElementById('authContainer').style.display='flex'; document.getElementById('mainApp').classList.remove('show'); document.getElementById('loginFormElement').reset(); document.getElementById('registerFormElement').reset(); document.getElementById('resetFormElement').reset(); } }

        // 语音
        function initSpeechRecognition(){ if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){ const SR= window.SpeechRecognition||window.webkitSpeechRecognition; recognition=new SR(); recognition.continuous=false; recognition.interimResults=false; recognition.lang='zh-CN'; recognition.onstart=function(){ setVoiceStatus('listening','🎤 正在听取您的语音...'); }; recognition.onresult=function(e){ const t=e.results[0][0].transcript; setVoiceStatus('processing','🔄 正在处理语音内容...'); setTimeout(()=>{ const r=parseVoiceInput(t); if(r){ $('type').value=r.type; $('amount').value=r.amount; $('category').value=r.category; $('description').value=r.description; setVoiceStatus('success',`✅ 已识别: ${r.description} ${r.amount}元`); showTab(null,'add'); } else { setVoiceStatus('error','❌ 无法识别语音内容，请重试'); } }, 600); }; recognition.onerror=function(ev){ setVoiceStatus('error','❌ 语音识别失败: '+ev.error); }; recognition.onend=function(){ setTimeout(()=>{ $('voiceStatus').style.display='none'; },1500); }; } }
        function startVoiceInput(){ 
            if(!recognition){ 
                const msg = '您的浏览器不支持语音识别功能\n\n' +
                    '提示：\n' +
                    '1. 请使用 Chrome、Edge 或 Safari 浏览器\n' +
                    '2. 确保网站使用 HTTPS 协议（GitHub Pages 已满足）\n' +
                    '3. 允许浏览器访问麦克风权限\n' +
                    '4. 如仍无法使用，请尝试手动输入';
                alert(msg); 
                return; 
            } 
            try {
                recognition.start();
            } catch(e) {
                setVoiceStatus('error', '❌ 请先允许浏览器访问麦克风权限');
                setTimeout(() => {
                    $('voiceStatus').style.display = 'none';
                }, 2000);
            }
        }
        function setVoiceStatus(type,msg){ const d=$('voiceStatus'); d.className='voice-status '+type; d.textContent=msg; d.style.display='block'; }
        function parseVoiceInput(text){ const clean=text.replace(/[，。！？\s]/g,''); const m=clean.match(/(\d+(?:\.\d+)?)元?/); if(!m) return null; const amount=parseFloat(m[1]); let type='expense', category='其他', description=clean; if(clean.includes('工资')||clean.includes('收入')||clean.includes('奖金')){ type='income'; if(clean.includes('工资')) category='工资'; else if(clean.includes('奖金')) category='奖金'; else category='其他'; } else { if(clean.includes('早餐')||clean.includes('午餐')||clean.includes('晚餐')||clean.includes('吃饭')||clean.includes('餐饮')) category='餐饮'; else if(clean.includes('打车')||clean.includes('交通')||clean.includes('地铁')||clean.includes('公交')||clean.includes('出租车')) category='交通'; else if(clean.includes('购物')||clean.includes('超市')||clean.includes('商场')) category='购物'; else if(clean.includes('娱乐')||clean.includes('电影')||clean.includes('游戏')) category='娱乐'; else if(clean.includes('医疗')||clean.includes('医院')||clean.includes('药')) category='医疗'; else if(clean.includes('教育')||clean.includes('学费')||clean.includes('书')) category='教育'; }
            return { type, amount, category, description }; }

        // 页面切换与数据
        function showTab(e,tab){
            document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
            document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
            if(tab){
                document.getElementById(tab).style.display='block';
                if(e&&e.target) e.target.classList.add('active');
                else {
                    const btnMap={home:0,add:1,history:2,stats:3,settings:4};
                    const btns=document.querySelectorAll('.nav-tab');
                    const idx=btnMap[tab];
                    if(btns[idx]) btns[idx].classList.add('active');
                }
                if(tab==='history') displayTransactions();
                if(tab==='stats') drawCharts();
                if(tab==='settings') {
                    if(currentUser) {
                        $('settingsUsername').textContent = currentUser.username;
                        $('settingsRegisterTime').textContent = currentUser.registerTime ? new Date(currentUser.registerTime).toLocaleString('zh-CN') : '未知';
                        renderSettingsQuestions(currentUser);
                        loadGithubTokenDisplay();
                    }
                }
            }
        }
        document.getElementById('transactionForm').addEventListener('submit', function(e){ e.preventDefault(); const t={ id:Date.now(), type:$('type').value, amount:parseFloat($('amount').value), category:$('category').value, description:$('description').value, date:$('date').value }; transactions.unshift(t); userManager.saveUserTransactions(transactions); updateStats(); updateRecentTransactions(); clearForm(); alert('交易添加成功！'); autoSyncToCloud(true); });
        function useTemplate(description,type,category,amount){ $('type').value=type; $('amount').value=amount; $('category').value=category; $('description').value=description; }
        function clearForm(){ $('transactionForm').reset(); $('date').value=new Date().toISOString().split('T')[0]; }
        function updateStats(){ const inc=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0); const exp=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0); const bal=inc-exp; $('totalIncome').textContent=`¥${inc.toFixed(2)}`; $('totalExpense').textContent=`¥${exp.toFixed(2)}`; $('balance').textContent=`¥${bal.toFixed(2)}`; }
        function updateRecentTransactions(){ const c=$('recentTransactions'); const recent=transactions.slice(0,5); if(recent.length===0){ c.innerHTML='<p style="text-align:center;color:#666;padding:18px;">暂无交易记录</p>'; return; } c.innerHTML=recent.map(t=>`<div class="transaction-item"><div><div><strong>${t.description}</strong></div><div style=\"color:#666;font-size:0.9rem;\">${t.category} • ${t.date}</div></div><div class="transaction-amount ${t.type}">${t.type==='income'?'+':'-'}¥${t.amount.toFixed(2)}</div></div>`).join(''); }
        // 修改历史列表渲染，添加删除按钮
        function displayTransactions() {
            const listDiv = document.getElementById('transactionList');
            if (transactions.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color: #666; padding: 20px;">暂无交易记录</p>';
                return;
            }
            listDiv.innerHTML = transactions.map((t, idx) => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div style="font-size:1.12em;"><strong>${t.description}</strong></div>
                        <div style="color: #666; font-size: 0.96em;">${t.category} • ${t.date}</div>
                    </div>
                    <div class="transaction-amount ${t.type}" style="font-weight:600;">${t.type === 'income' ? '+' : '-'}¥${t.amount.toFixed(2)}</div>
                    <button class="delete-btn" onclick="deleteTransaction(${t.id})" title="删除">
                      <svg class="delete-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3a3 3 0 0 1 6 0v1h5v2h-1v13a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V6H4V4h5V3Zm2 1v1h2V4a1 1 0 1 0-2 0ZM7 6v13a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6H7Zm2 3h2v8h-2V9Zm4 0h-2v8h2V9Z"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        // 删除流水
        function deleteTransaction(id) {
            if (!confirm('确定要删除这条账单记录吗？')) return;
            transactions = transactions.filter(t => t.id !== id);
            userManager.saveUserTransactions(transactions);
            updateStats();
            updateRecentTransactions();
            displayTransactions();
            autoSyncToCloud(true);
        }
        function filterTransactions(){ const s=($('searchInput').value||'').toLowerCase(); const cf=$('categoryFilter').value; const tf=$('typeFilter').value; const filtered=transactions.filter(t=>{ const mS=(t.description||'').toLowerCase().includes(s) || (t.category||'').toLowerCase().includes(s); const mC=!cf || t.category===cf; const mT=!tf || t.type===tf; return mS && mC && mT; }); const list=$('transactionList'); if(filtered.length===0){ list.innerHTML='<p style="text-align:center;color:#666;padding:18px;">没有找到匹配的交易</p>'; return; } list.innerHTML=filtered.map(t=>`<div class="transaction-item"><div><div><strong>${t.description}</strong></div><div style=\"color:#666;font-size:0.9rem;\">${t.category} • ${t.date}</div></div><div class="transaction-amount ${t.type}">${t.type==='income'?'+':'-'}¥${t.amount.toFixed(2)}</div></div>`).join(''); }
        // 恢复统计分析柱状图
        function drawCharts() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            ctx.clearRect(0, 0, 400, 220);
            const allCategories = Array.from(new Set(transactions.map(t => t.category)));
            const incomeByCat = {}, expenseByCat = {};
            allCategories.forEach(cat=>{incomeByCat[cat]=0; expenseByCat[cat]=0;});
            transactions.forEach(t => {
                if (t.type==='income') incomeByCat[t.category] += t.amount;
                if (t.type==='expense') expenseByCat[t.category] += t.amount;
            });
            if (allCategories.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无分类收支数据', 200, 110);
                return;
            }
            const barWidth = 220 / allCategories.length;  // 总宽度220，适配分组宽度
            const barGap = 10;
            const baseLeft = 54;
            // 获取最大柱子高度
            const maxAmount = Math.max(
                ...allCategories.map(cat => Math.max(incomeByCat[cat], expenseByCat[cat]))
            ) || 1;
            allCategories.forEach((category, i) => {
                const inc = incomeByCat[category] || 0;
                const exp = expenseByCat[category] || 0;
                // 绘制收入
                let x = baseLeft + i*barWidth;
                let h = (inc/maxAmount)*120;
                ctx.fillStyle = '#43a047';
                ctx.fillRect(x, 170-h, (barWidth-barGap)/2, h);
                ctx.fillStyle = '#222';
                ctx.font = '15px Arial';
                ctx.textAlign = 'center';
                if(inc>0) ctx.fillText(`+${inc.toFixed(2)}`, x+(barWidth-barGap)/4, 162-h);
                // 绘制支出
                x = baseLeft + i*barWidth + (barWidth-barGap)/2;
                h = (exp/maxAmount)*120;
                ctx.fillStyle = '#e53935';
                ctx.fillRect(x, 170-h, (barWidth-barGap)/2, h);
                ctx.fillStyle = '#222';
                if(exp>0) ctx.fillText(`-${exp.toFixed(2)}`, x+(barWidth-barGap)/4, 162-h);
                // 标题
                ctx.font = '16px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(category, baseLeft+i*barWidth+barWidth/2-5, 202);
            });
            // 标题高亮
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#222';
            ctx.fillText('分类统计', 77, 28);
            // 图例
            ctx.fillStyle = '#43a047'; ctx.fillRect(286, 40, 18, 18);
            ctx.fillStyle = '#222'; ctx.font = '15px Arial'; ctx.textAlign = 'left'; ctx.fillText('收入', 310, 52);
            ctx.fillStyle = '#e53935'; ctx.fillRect(286, 68, 18, 18);
            ctx.fillStyle = '#222'; ctx.fillText('支出', 310, 81);
        }
        // [Excel 导出]
        function exportData() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['类型', '金额', '分类', '描述', '日期']
            ];
            transactions.forEach(t => {
                wsData.push([
                    t.type === 'income' ? '收入' : '支出',
                    t.amount,
                    t.category,
                    t.description,
                    t.date
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, '流水');
            XLSX.writeFile(wb, `${currentUser.username}_记账数据_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        // [Excel 导入]
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        try{
                            const data = ev.target.result;
                            const workbook = XLSX.read(data, {type:'binary'});
                            const wsName = workbook.SheetNames[0];
                            const ws = workbook.Sheets[wsName];
                            const rows = XLSX.utils.sheet_to_json(ws, {header:1,defval:''});
                            // 解析并验证
                            let colIdx = {
                                类型: -1, 金额: -1, 分类: -1, 描述: -1, 日期: -1
                            };
                            rows[0].forEach((h,i)=>{if(h in colIdx) colIdx[h]=i;});
                            if(Object.values(colIdx).some(idx=>idx===-1)){ alert('Excel表头必须包含：类型、金额、分类、描述、日期'); return; }
                            const addList = [];
                            for(let i=1; i<rows.length; i++){
                                const r = rows[i];
                                if(!r[colIdx.金额] || !r[colIdx.类型]) continue;
                                addList.push({
                                    id: Date.now() + Math.random(),
                                    type: r[colIdx.类型].trim() === '收入' ? 'income':'expense',
                                    amount: parseFloat(r[colIdx.金额]) || 0,
                                    category: r[colIdx.分类]||'其他',
                                    description: r[colIdx.描述]||'',
                                    date: r[colIdx.日期]||new Date().toISOString().split('T')[0]
                                });
                            }
                            if(addList.length===0){ alert('没有有效数据'); return; }
                            // 插入到账本
                            transactions = addList.concat(transactions);
                            userManager.saveUserTransactions(transactions);
                            updateStats();
                            updateRecentTransactions();
                            alert('数据导入成功！');
                        }catch(e){ alert('文件解析失败！'); }
                    };
                    reader.readAsBinaryString(file);
                }
            };
            input.click();
        }
        function clearAllData(){ if(confirm('确定要清空所有数据吗？此操作不可恢复！')){ transactions=[]; userManager.saveUserTransactions(transactions); updateStats(); updateRecentTransactions(); alert('所有数据已清空'); autoSyncToCloud(true); } }
        function clearAllUsers(){
            if(confirm('此操作将删除所有注册用户与会话信息，且不可恢复。是否继续？')){
                try{
                    localStorage.removeItem('users');
                    localStorage.removeItem('currentUser');
                    alert('已清除所有注册记录，现在将返回登录页');
                    location.reload();
                }catch(e){
                    alert('清除失败：'+ e.message);
                }
            }
        }

        // ========== 自动云同步功能（基于 GitHub Gist） ==========
        const GIST_FILENAME = 'family-accounting-data.json';
        let gistId = localStorage.getItem('gistId') || null;
        let isSyncing = false; // 防止并发同步

        // 检查是否启用自动同步
        function isAutoSyncEnabled(){
            return localStorage.getItem('autoSyncEnabled') === 'true';
        }

        // 切换自动同步开关
        function toggleAutoSync(){
            const enabled = $('autoSyncEnabled').checked;
            localStorage.setItem('autoSyncEnabled', enabled ? 'true' : 'false');
            if(enabled){
                const token = localStorage.getItem('githubToken');
                if(!token){
                    alert('请先设置 GitHub Token！');
                    $('autoSyncEnabled').checked = false;
                    localStorage.setItem('autoSyncEnabled', 'false');
                    return;
                }
                toast('自动同步已开启，数据将自动保存到云端','success');
                // 立即上传一次
                autoSyncToCloud(true);
            } else {
                toast('自动同步已关闭','success');
            }
        }

        // 保存 GitHub Token
        function saveGithubToken(){
            const token = $('githubToken').value.trim();
            if(!token){
                alert('请输入 GitHub Token');
                return;
            }
            localStorage.setItem('githubToken', token);
            $('githubToken').value = '';
            toast('Token 已保存','success');
            // 如果已开启自动同步，立即上传
            if(isAutoSyncEnabled()){
                autoSyncToCloud(true);
            }
        }

        // 自动上传到云端（静默模式，不显示确认框）
        async function autoSyncToCloud(silent = false){
            if(isSyncing) return; // 防止并发
            const token = localStorage.getItem('githubToken');
            if(!token || !isAutoSyncEnabled()) return;
            
            isSyncing = true;
            const statusEl = $('syncStatus');
            if(!silent && statusEl){
                statusEl.innerHTML = '⏳ 正在同步到云端...';
                statusEl.style.color = '#f57c00';
            }
            try{
                const allData = {
                    users: userManager.users,
                    syncTime: new Date().toISOString(),
                    version: '1.0'
                };
                const content = JSON.stringify(allData, null, 2);
                const url = gistId 
                    ? `https://api.github.com/gists/${gistId}`
                    : 'https://api.github.com/gists';
                const method = gistId ? 'PATCH' : 'POST';
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: '家庭记账助手 - 云端数据同步',
                        public: false,
                        files: {
                            [GIST_FILENAME]: {
                                content: content
                            }
                        }
                    })
                });
                if(!response.ok){
                    const error = await response.json();
                    throw new Error(error.message || '上传失败');
                }
                const result = await response.json();
                gistId = result.id;
                localStorage.setItem('gistId', gistId);
                if(statusEl){
                    statusEl.innerHTML = '✅ 自动同步中...';
                    statusEl.style.color = '#2e7d32';
                }
            }catch(err){
                if(statusEl){
                    statusEl.innerHTML = '❌ 同步失败: ' + err.message;
                    statusEl.style.color = '#c62828';
                }
                console.error('自动同步失败:', err);
            }finally{
                isSyncing = false;
            }
        }

        // 自动从云端下载（静默模式，页面加载时调用）
        async function autoSyncFromCloud(silent = false){
            if(isSyncing) return;
            const token = localStorage.getItem('githubToken');
            if(!token || !isAutoSyncEnabled() || !gistId) return;
            
            isSyncing = true;
            try{
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                if(!response.ok) throw new Error('下载失败');
                
                const result = await response.json();
                const file = result.files[GIST_FILENAME];
                if(!file) return;
                
                const cloudData = JSON.parse(file.content);
                if(!cloudData.users || !Array.isArray(cloudData.users)) return;
                
                // 智能合并：以云端数据为主，但保留本地新增的用户
                const localUsers = userManager.users;
                const cloudUsers = cloudData.users;
                const userMap = new Map();
                
                // 先添加所有云端用户
                cloudUsers.forEach(u => userMap.set(u.username, u));
                // 再添加本地独有的用户
                localUsers.forEach(localUser => {
                    if(!userMap.has(localUser.username)){
                        userMap.set(localUser.username, localUser);
                    }
                });
                
                const mergedUsers = Array.from(userMap.values());
                userManager.users = mergedUsers;
                localStorage.setItem('users', JSON.stringify(mergedUsers));
                
                // 更新当前用户数据
                if(currentUser){
                    const updatedUser = mergedUsers.find(u => u.username === currentUser.username);
                    if(updatedUser){
                        currentUser = updatedUser;
                        transactions = userManager.getUserTransactions();
                        userManager.currentUser = updatedUser;
                        localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                        updateStats();
                        updateRecentTransactions();
                    }
                }
                
                if(!silent && $('syncStatus')){
                    $('syncStatus').innerHTML = '✅ 已从云端同步最新数据';
                    $('syncStatus').style.color = '#2e7d32';
                }
            }catch(err){
                console.error('自动下载失败:', err);
                if(!silent && $('syncStatus')){
                    $('syncStatus').innerHTML = '⚠️ 同步失败，使用本地数据';
                    $('syncStatus').style.color = '#f57c00';
                }
            }finally{
                isSyncing = false;
            }
        }

        // 立即同步（手动触发）
        async function manualSyncNow(){
            const token = localStorage.getItem('githubToken');
            if(!token){
                alert('请先设置 GitHub Token！');
                return;
            }
            const statusEl = $('syncStatus');
            statusEl.innerHTML = '🔄 正在同步...';
            statusEl.style.color = '#f57c00';
            
            // 先下载
            await autoSyncFromCloud(false);
            // 再上传
            await autoSyncToCloud(false);
            
            setTimeout(() => {
                statusEl.innerHTML = '✅ 同步完成';
                statusEl.style.color = '#2e7d32';
            }, 500);
        }

        // 页面加载时显示已保存的设置
        function loadGithubTokenDisplay(){
            const token = localStorage.getItem('githubToken');
            if(token){
                $('githubToken').placeholder = `已设置 Token: ${token.substring(0, 4)}****（点击输入框可修改）`;
            }
            const autoSync = isAutoSyncEnabled();
            if($('autoSyncEnabled')){
                $('autoSyncEnabled').checked = autoSync;
            }
            const savedGistId = localStorage.getItem('gistId');
            if(savedGistId && $('syncStatus')){
                const status = autoSync ? '✅ 自动同步已开启' : '📌 自动同步已关闭';
                $('syncStatus').innerHTML = status + ' | Gist: ' + savedGistId.substring(0, 8) + '...';
                $('syncStatus').style.color = autoSync ? '#2e7d32' : '#666';
            }
        }

        // Tab切换修复，实现tab可切换登录/注册/找回
        function showAuthTab(event, tab) {
            document.querySelectorAll('.auth-tab').forEach(btn=>btn.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            document.getElementById('loginForm').style.display = tab==='login' ? 'block':'none';
            document.getElementById('registerForm').style.display = tab==='register' ? 'block':'none';
            document.getElementById('resetForm').style.display = tab==='reset' ? 'block':'none';
        }
        function showAuthTabByName(tab) {
            document.querySelectorAll('.auth-tab').forEach(btn=>{
                if(btn.dataset.tab === tab) btn.click();
            });
        }

        // 主应用显示
        function showMainApp(user){
            document.getElementById('authContainer').style.display='none';
            document.getElementById('mainApp').classList.add('show');
            document.getElementById('userAvatar').textContent=user.username.charAt(0).toUpperCase();
            document.getElementById('userName').textContent=user.username;
            document.getElementById('userEmail').textContent=user.username+'@example.com'; // 示例邮箱
            // 显示所有主应用tab内容
            document.querySelectorAll('.nav-tab').forEach(tabBtn=>{
                tabBtn.classList.remove('active');
                if(tabBtn.textContent.includes('首页')) tabBtn.classList.add('active');
            });
            document.querySelectorAll('.tab-content').forEach(tabContent=>{
                tabContent.style.display='none';
            });
            document.getElementById('home').style.display='block';
            updateStats();
            updateRecentTransactions();
            // -- 删除 refreshLocalOtp --
            // refreshLocalOtp();
        }

        // 登录表单事件修正
        document.getElementById('loginFormElement').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            try{
                const user = userManager.login(username, password);
                currentUser = user;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // 自动从云端同步（如果有开启）
                await autoSyncFromCloud(true);
                // 同步后再上传（确保本地最新数据也在云端）
                autoSyncToCloud(true);
            }catch(err){
                alert(err.message);
            }
        });
        // 注册表单事件修正
        document.getElementById('registerFormElement').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            if(password !== confirm){ alert('两次输入的密码不一致'); return; }
            if(password.length < 6){ alert('密码长度至少6位'); return; }
            const securityQAs = collectSecurityQuestions('#securityQuestionsContainer');
            try{
                // 注册前先同步云端数据（以防其他设备有新用户）
                await autoSyncFromCloud(true);
                const user = userManager.register(username, password, securityQAs);
                currentUser = user;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // 注册后自动上传到云端
                autoSyncToCloud(true);
            }catch(err){
                alert(err.message);
            }
        });
        // 找回密码表单事件修正（假定实现已经有resetPassword方法）
        if(document.getElementById('resetFormElement')){
        document.getElementById('resetFormElement').addEventListener('submit', function(e){
            e.preventDefault();
            const username = document.getElementById('resetUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;
            const answers = collectSecurityAnswers('#resetSecurityDynamicArea');
            if(newPassword !== confirm){ alert('两次输入的新密码不一致'); return; }
            if(newPassword.length < 6){ alert('密码长度至少6位'); return; }
            try{
                // 只要任意一道安全问题答案对应即可重置
                const user = userManager.users.find(u=>u.username === username);
                if(!user){ alert('用户不存在'); return; }
                if(!user.securityQA || !answers.length){ alert('请填写正确的安全问题答案'); return; }
                let ok = false;
                for(const ans of answers){
                    const found = user.securityQA.find(q=>q.q === ans.q);
                    if(found && found.aHash === userManager.hashPassword(userManager.normalizeAnswer(ans.a))){ ok = true; break; }
                }
                if(!ok){ alert('安全问题答案不正确'); return; }
                user.password = userManager.hashPassword(newPassword);
                localStorage.setItem('users', JSON.stringify(userManager.users));
                // 密码重置后自动同步到云端
                autoSyncToCloud(true);
                alert('密码重置成功，请登录！');
                showAuthTabByName('login');
            }catch(err){
                alert('重置失败:'+err.message);
            }
        });
        }

        // 找回密码页：用户名输入时动态显示安全问题
        document.getElementById('resetUsername').addEventListener('blur', function(){
            renderResetSecurityArea();
        });

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function(){
            // 初始化语音识别
            initSpeechRecognition();
            // 初始化日期为今天
            clearForm();
            // 检查是否已登录
            const savedUser = userManager.getCurrentUser();
            if(savedUser){
                currentUser = savedUser;
                transactions = userManager.getUserTransactions();
                showMainApp(currentUser);
                // 如果开启了自动同步，页面加载时自动从云端下载最新数据
                await autoSyncFromCloud(true);
                // 下载后立即上传，确保云端有最新数据
                autoSyncToCloud(true);
            }
            // 初始化注册页安全问题
            initSecurityQuestionUI();
            // 加载 GitHub Token 显示
            loadGithubTokenDisplay();
        });
    </script>
</body>
</html>
